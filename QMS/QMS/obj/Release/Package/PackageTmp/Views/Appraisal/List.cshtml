@using HRMS.Utilities;
@{
    /**/

    ViewBag.Title = "List";
    Layout = "~/Views/Shared/Layout.cshtml";
    var subModules = Session["subModules"] != null ? (List<HRMS.Data.SubModule>)Session["subModules"] : new List<HRMS.Data.SubModule>();
    var Managers = (List<HRMS.Data.Employee>)(ViewBag.Managers);
    var Sites = (List<HRMS.Data.Site>)(ViewBag.Sites);
    int subModuleId = subModules.Where(m => m.Name == "My Appraisal").FirstOrDefault().Id;
    bool canAdd = HRMS.Utilities.PermissionChecker.HasPermission(subModuleId, 2);
    bool canEdit = HRMS.Utilities.PermissionChecker.HasPermission(subModuleId, 3);
    bool canDelete = HRMS.Utilities.PermissionChecker.HasPermission(subModuleId, 4);
    //bool canAdd = true;
    //bool canEdit = true;
    //bool canDelete = true;
}

<head>
    <meta name="viewport" content="width=device-width" />
    <link href="~/jquery-ui-1.12.1/jquery-ui-1.12.1/jquery-ui.min.css" rel="stylesheet" />
    <link href="~/jquery-ui-1.12.1/jquery-ui-1.12.1/jquery-ui.structure.css" rel="stylesheet" />
    <link href="~/jquery-ui-1.12.1/jquery-ui-1.12.1/jquery-ui.theme.css" rel="stylesheet" />
    <title>Test</title>

    <style>
        .ui-datepicker {
            background: #5c7682;
            border: 1px solid blue;
            color: black
        }
    </style>
</head>


<main class="bg-white-500 flex-1 p-3 overflow-hidden">
    <div class="flex flex-col">
        <!--Grid Form-->
        <div class="flex flex-1  flex-col md:flex-row lg:flex-row mx-2">
            <div class="mb-2 border-solid border-gray-300 rounded border shadow-sm w-full">
                <div class="bg-gray-200 px-2 py-3 border-solid border-gray-200 border-b">
                    <span>Objectives</span>



                    @if (canAdd)

                    {
                        <span style="float:right;">
                            @*<button class=" btn btn-primary" id="validateAppraisal">
                                    New Objectives
                                </button>*@
                            <button class=" btn btn-primary" id="modalQuarterOpener" data-toggle="modal" data-target="#myModalQuarter" onclick="modalQuarterOpenFunction()">
                                New Objectives
                            </button>
                            @*<button type="button" class=" btn btn-primary pdf-report" id="validateAppraisal">
                                   PDF Report
                                </button>*@


                            @*<a id="addAppraisal" class="bg-green-500 hover:bg-green-800 text-white font-bold py-2 px-4 rounded" href="@Url.Content("~/Appraisal/Add")">
                                    Add Appraisal
                                </a>*@

                        </span>

                        <div name="modal" class="modal" id="myModalQuarter" style="margin-top:300px; padding:10px; margin-left:30%">
                            <div class="modal-dialog ">
                                <div class="modal-content">

                                    <!-- Modal Header -->
                                    <div class="modal-header  bg-blue-600">

                                        Objectives
                                    </div>

                                    <!-- Modal body -->
                                    <div class="modal-body">


                                        <div class="flex flex-wrap -mx-3 mb-6">
                                            <div class="w-full md:w-1/2 px-3 mb-6 md:mb-0">
                                                <label class="block uppercase tracking-wide text-gray-700 text-xs font-light mb-1"
                                                       for="Quarter">
                                                    Select Quarter
                                                </label>
                                                <div class="relative">
                                                    <select class="appearance-none block w-full bg-gray-200 text-grey-darker border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white-500 focus:border-gray-600"
                                                            id="Quarter" name="Quarter">
                                                        <option value="1" selected>Quarter 1</option>
                                                        <option value="2">Quarter 2</option>
                                                        <option value="3">Quarter 3</option>
                                                        <option value="4">Quarter 4</option>

                                                    </select>
                                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-grey-darker">
                                                        <svg class="fill-current h-4 w-4" xmlns="#"
                                                             viewBox="0 0 20 20">
                                                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                                        </svg>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="w-full md:w-1/2 px-3">

                                            </div>
                                        </div>

                                        <div class="w-full md:w-1/3 px-2 mb-6 md:mb-0">
                                            <label class="block uppercase tracking-wide text-gray-700 text-xs font-light mb-1"
                                                   for="AppraisalYear">
                                                Year
                                            </label>
                                            <input disabled class="appearance-none block w-full bg-white text-gray-700 border border-red-500 rounded py-2 px-4 mb-1 leading-tight focus:outline-none focus:bg-white-500"
                                                   id="AppraisalYear" name="AppraisalYear" type="text" placeholder="Enter Employee Code" autocomplete="off" value="@DateTime.Now.Year.ToString()">
                                            <input hidden class="appearance-none block w-full bg-white text-gray-700 border border-red-500 rounded py-2 px-4 mb-1 leading-tight focus:outline-none focus:bg-white-500"
                                                   id="AppraisalYear" name="AppraisalYear" type="text" placeholder="Enter Employee Code" autocomplete="off" value="@DateTime.Now.Year.ToString()">
                                            @*<p class="text-red-500 text-xs italic">Please fill out this field.</p>*@
                                        </div>


                                    </div>

                                    <!-- Modal footer -->
                                    <div class="modal-footer p-1">

                                        <button id="validateAppraisal" class="btn btn-primary  float-right " data-dismiss="myModalQuarter">Add</button>
                                        <button id="btnClose" class="btn btn-primary  float-right " data-dismiss="myModalQuarter">Cancel</button>





                                    </div>

                                </div>
                            </div>
                        </div>

                    }


                    @if (TempData["addSuccessMessage"] != null)
                    {
                        <div class="bg-green-200 text-success text-center p-3 w-25 border-1 m-1 float-end addMessage">
                            @TempData["addSuccessMessage"]
                            <i class="fa fa-times float-end hover:bg-white cancelMessage" aria-hidden="true"></i>
                        </div>
                    }
                    @if (TempData["addErrorMessage"] != null)
                    {
                        <div class="bg-red-200 text-danger text-center  p-3 w-25 border-1 m-1 float-end addMessage">
                            @TempData["addErrorMessage"]
                            <i class="fa fa-times float-end hover:bg-white cancelMessage" aria-hidden="true"></i>
                        </div>
                    }



                </div>
                <div class="row searchSection">
                    @using (Html.BeginForm("List", "Appraisal", FormMethod.Post))
                    {

                        <label class=" control-label px-4 py-2">Search</label>

                        <input type="text" name="search" placeholder="Search" class="border-1 border-gray-400 px-3 py-2 mt-2" />

                        <button class="btn btn-primary mb-2 ml-2" type="submit">
                            <i class="fa fa-search"></i>

                            Search
                        </button>



                    }

                </div>
                <div class="p-3">
                    <table class="table-responsive w-full rounded">
                        <thead class="bg-blue-500 text-white text-xs">
                            <tr>
                                <th class="border w-1/12 px-1 py-2 text-center">Emp_Code</th>
                                <th class="border w-1/12 px-1 py-2 text-center">Employee Name</th>
                                <th class="border w-1/12 px-1 py-2 text-center">Title</th>
                                <th class="border w-1/12 px-1 py-2 text-center">Supervisor</th>
                                <th class="border w-1/12 px-1 py-2 text-center">Location</th>
                                <th class="border w-1/12 px-1 py-2 text-center">Year</th>
                                <th class="border w-1/12 px-1 py-2 text-center">Qtr</th>
                                <th class="border w-1/12 px-1 py-2 text-center">Status</th>
                                <th class="border w-4/12 px-1 py-2 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mytbody">
                            @if (ViewBag.Appraisals != null && ViewBag.Appraisals.Count > 0)
                            {
                                foreach (var Appraisal in ViewBag.Appraisals)
                                {
                            <tr>
                                <td class="border px-1 py-2 text-xs text-center">@Appraisal.Emp_Code</td>
                                <td class="border px-1 py-2 text-xs text-center">@Appraisal.Emp_Name</td>
                                <td class="border px-1 py-2 text-xs text-center">@Appraisal.Emp_Title</td>
                                <td class="border px-1 py-2 text-xs text-center">@(Managers.Where(x => x.Id.Equals(Appraisal.Manager_Id)).FirstOrDefault().FirstName + " " + Managers.Where(x => x.Id.Equals(Appraisal.Manager_Id)).FirstOrDefault().LastName)</td>
                                @*<td class="border px-1 py-2 text-xs text-center">@(Appraisal.Site_Id != 0 ? (Sites.Where(x => x.Id.Equals(Appraisal.Site_Id)).FirstOrDefault().Country.Name) : "")</td>*@
                                <td class="border px-1 py-2 text-xs text-center">@(Appraisal.Site_Id != 0 ? (Sites.Where(x => x.Id.Equals(Appraisal.Site_Id)).FirstOrDefault().Description) : "")</td>
                                <td class="border px-1 py-2 text-xs text-center">@Appraisal.AppraisalYear</td>
                                <td class="border px-1 py-2 text-xs text-center">@((HRMS.Utilities.Enums.Quarter)Appraisal.Quarter)</td>
                                <td class="border px-1 py-2 text-xs text-center">@(((Enums.Status)Appraisal.Status).ToString().Replace("_", " "))</td>
                                <td class="border px-1 py-2">
                                    @if (canEdit)
                                    {
                                        <a class="btn-sm btn-success m-1 no-underline    " href="@Url.Content("~/Appraisal/EditMyAppraisal/" + Appraisal.Id)">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    }
                                    @*@if (canDelete)

            {
                <a class="btn-sm btn-danger m-1" href="@Url.Content("~/Appraisal/Delete/" + Appraisal.Id)">
                    <i class="fas fa-trash"></i>
                </a>
            }*@


                                    <a class="btn-sm btn-primary m-1 no-underline" href="@Url.Content("~/Appraisal/MyDetailPreview/" + Appraisal.Id)">

                                        Preview

                                        @*<i class="fas fa-edit"></i>*@
                                    </a>


                                    @*<a class="btn-sm btn-secondary m-1 @(((Appraisal.IsTransferred==false) && (DateTime.Now.Month>= Convert.ToInt32(Appraisal.Quarter.ToString().Replace("1","4").Replace("2","7").Replace("3","10")))) ? "" :"hide") " href="@Url.Content("~/Appraisal/PostObjectives/" + Appraisal.Id)">
                Post

            </a>*@

                                    <button id="postObjectiveClick" type="button" class="btn-sm btn-success m-1  @(((Appraisal.IsTransferred==false) && (DateTime.Now.Month> Appraisal.Quarter*3) && (DateTime.Now.Month <= Appraisal.Quarter*3+3)) ? "" :"hide") " value="@Appraisal.Id" onclick="postObjectivesFunc(this)">
                                        Post To Next Quarter

                                    </button>

                                    @*<button id="modalPostObjectives" type="button" class="btn-sm btn-secondary @(((Appraisal.IsTransferred==false) && (DateTime.Now.Month> Appraisal.Quarter*3) && (DateTime.Now.Month <= Appraisal.Quarter*3+3)) ? "" :"hide") " data-toggle="modal" data-target="#PostObjectives"  value="@Appraisal.Id" onclick="postObjectivesFunc(this)">Post To Next Quarter</button>*@

                                </td>
                            </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="12" class="border px-4 py-4">
                                        No Record Found!
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    
                    <div name="modal" class="modal" id="PostObjectives" style="margin-top:100px; padding:10px; margin-left:30%">
                        <div class="modal-dialog ">
                            <div class="modal-content">

                                <!-- Modal Header -->
                                <div class="modal-header  bg-blue-600">

                                    Confirmation Alert!
                                </div>

                                <!-- Modal body -->
                                <div class="modal-body">


                                    <p id="psending"> Do you really want to post/transfer the objectives to next quarter?</p>


                                </div>

                                <!-- Modal footer -->
                                <div class="modal-footer p-1">

                                    <button id="PostYes" class="btn btn-primary  float-right " data-dismiss="PostObjectives">Yes</button>

                                    <button id="PostNo" class="btn btn-primary" data-dismiss="PostObjectives">No</button>



                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <!--/Grid Form-->
    </div>
</main>
<script src="~/Scripts/jquery-3.6.0.js"></script>
<script src="~/jquery-ui-1.12.1/jquery-ui-1.12.1/jquery-ui.min.js"></script>
<script type="text/javascript">

    
    $(document).ready(function () {

        $('#btnClose').click(function () {

            $('#myModalQuarter').modal('hide');
        });


        //$('#validateAppraisal').click(function () {



        //    $('#myModal').modal('hide');



        //});

        if ($('#mytbody').children('tr').length < 2) {

            $('.searchSection').addClass('hide');

        }
        $('.cancelMessage').click(function () {
            $('.addMessage').addClass('hide');
        })

    });
        @*$('#validateAppraisal').click(function () {


            var Code ='@ViewBag.employeeCode';
            var Year ='@DateTime.Now.Year.ToString()';

            var Url = '@Url.Content("~/Appraisal/ValidateAppraisal")';
            //alert(Url);
            $.ajax({
                url: Url,
                type: 'GET',
                data: { code: Code, year: Year },
                success: function (response) {
                    var data = JSON.parse(response);
                    if (data == true) {
                        alert('Record already exists for this year, Please update existing record.')
                    }
                    else {
                       window.location = "@Url.Action("Add", "Appraisal")"
                    };
                },
                error: function () {

                }
            });

    });*@

        $('#validateAppraisal').click(function () {


            var Code = '@ViewBag.employeeCode';

            var Year = '@DateTime.Now.Year.ToString()';

            var Quarter = $('#Quarter').val();


            var Url = '@Url.Content("~/Appraisal/ValidateAppraisal")';
            //alert(Url);
            $.ajax({
                url: Url,
                type: 'GET',
                data: { code: Code, year: Year, quarter: Quarter },
                success: function (response) {
                    var data = JSON.parse(response);
                    if (data == true) {
                        alert('Record already exists for the given Quarter of the Year, Please update existing record.')
                    }
                    else {

                        var Qtr = $('#Quarter').val();

                        //if (Qtr == "Quarter 1"){
                        //    Qtr = 1;
                        //}
                        //else if (Qtr == "Quarter 2") {
                        //    Qtr = 2;
                        //}
                        //else if (Qtr == "Quarter 3") {
                        //    Qtr = 3;
                        //}
                        //else if (Qtr == "Quarter 4") {
                        //    Qtr = 4;
                        //}


                        window.location.href = "/Appraisal/Add/" + Qtr;
                    };
                },
                error: function () {

                }
            });

    });

    @*$(document).on("click", ".pdf-report", function () {

        var Url = '@Url.Content("~/Appraisal/PDFReportGenerate")';
        $.ajax({
            url: Url,
            data: '{}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            type: "POST",
            success: function (response) {
                var data = JSON.parse(response);
                alert(data);
                if (response.d.length > 0) {
                    window.open(response.d[0].pdfReportPath)
                }
            },
            error: function (response) {
                alert('Failed');
                alert(response.responseText);
            }


        });

    });*@

    var postObjId = "1";

    function modalQuarterOpenFunction(obj) {
        postObjId = $(obj).val();
        $('#myModalQuarter').modal('show');
    }

    function modalPostOpenFunction() {

        $('#PostObjectives').modal('show');
    }

    $('#PostNo').click(function () {
        $('#PostObjectives').modal('hide');
    });
    $('#PostYes').click(function () {
        //var Id = $('#AppraisalId').val();
        alert(postObjId);
       
        $('#PostObjectives').modal('hide');
        
        $('#postObjectiveClick').trigger('click');
       

        //alert("/Appraisal/PostObjectives/" + Id);
        //window.location.href = "/Appraisal/PostObjectives/" + Id;

        

    });

    function postObjectivesFunc(obj) {
        if (!confirm("Do you really want to post/transfer the objectives to next quarter?")) {
            return false;
        }
      
        var id = $(obj).val();
        
       
        
        window.location.href = "/Appraisal/PostObjectives/" + id;
    }

  

</script>
